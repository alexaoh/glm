---
title: "Impacte del COVID-19 per estat de vacunació"
subtitle: "Linear and Generalized Linear Models"
author: "Ulrik Danielsen, Alexander J Ohrt"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    theme: readable
    highlight: textmate
    number_sections: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE, warning = F, fig.width = 10)
# setwd("/home/ajo/gitRepos/glm/Deliverable")
library(dplyr)
library(lubridate)
library(ggplot2)
```

We are analyzing a data set that contains information about the impact of COVID-19 by vaccination status in 2021 in Catalunya. The data comes from various information systems of the Department of Health and the Catalan Health Service, as detailed [here](https://dadescovid.cat/documentacio). More specifically, the data shows the impact of COVID-19 (new cases, hospitalizations, critical hospitalizations and deaths) in the entirety of Catalunya, from January 1st 2021 until now, for the date of reference of each record, by gender, by age group, according to the vaccination status of the people. Keep in mind that a person is counted as many times as the number of events that has happened to the individual in question. This means that each person may be counted up to four times in the data set as a whole. More information about the data set can be found [here](https://analisi.transparenciacatalunya.cat/en/Salut/Impacte-del-COVID-19-per-estat-de-vacunaci-/6izj-g3sb). Note that the data we are using was downloaded December 17th at 12:00. 

The data set contains 6 columns. They are explained shortly below. 

| Variable      | SEXE        | EDAT                                                                        | DATA | ESDEVENIMENT                             | PAUTA                          | RECOMPTE |
|---------------|-------------|-----------------------------------------------------------------------------|------|------------------------------------------|--------------------------------|----------|
| Explanation   | Sex         | Age Group                                                                   | Date | Event (Severity of illness)              | Vaccination status             | Event Count    |
| Factor Levels | Homme, Dona, Not classified | 0-9, 10-19, 20-29,  30-39, 40-49, 50-59,  60-69, 70-79, 80$\geq$, Not classified |      | Cas, Hospitalització, Critics, Defunció  | No iniciada, Parcial, Completa |          |

# Objective

The objective of the analysis is to answer the following question: 
*Do differences in the severity of COVID-19 infection exist between people that are unvaccinated, people that only have received one dose and people that are fully vaccinated?*
More precisely, does the amount of people with a *critical* infection depend on their respective vaccination statuses? 

The analysis will be performed separately for men and women. Moreover, we will only consider people that are older than 30 and only data from May 1st to December 12th. Additionally, we will only analyze differences in people that are reported with a critical event, disregarding people with new cases, people that are hospitalized (not critical) and people that have died. 

# Data Preparation

First we have to remove all people younger than 30 years old and cases before May 1st. The data is prepared according to the description above. 

```{r}
data <- read.csv("Impacte_del_COVID-19.csv") # Data updated 17.12.21.

clean <- function(data){
  data$DATA <- as.Date(data$DATA, format = "%d/%m/%Y")
  #data$DATA <- parse_date_time(data$DATA, orders = "%d/%m/%Y")
  data$EDAT <- as.factor(data$EDAT)
  covid.data <- data %>% filter(DATA >= "2021-05-01" & DATA < "2021-12-13") %>% 
        filter(EDAT %in% c("30 a 39", "40 a 49", "50 a 59", "60 a 69", "70 a 79", "80 o més"))
        # People with EDAT "No classificat" are not added (these are the same people as "No classificat" in SEXE).
  
  covid.data$PAUTA <- factor(covid.data$PAUTA)
  covid.data$SEXE <- factor(covid.data$SEXE)
  
  # Create week and month variables.
  covid.data$Week <- as.factor(strftime(covid.data$DATA, format = "%W"))
  covid.data$Month <- as.factor(strftime(covid.data$DATA, format = "%m"))
  
  return(covid.data)
}
covid.data <- clean(data) %>% filter(ESDEVENIMENT == "Crítics")
```

Note also that there are `r dim(data %>% filter(SEXE == "No classificat" & EDAT == "No classificat"))[[1]]` registries in the data set that are not classified into groups in `SEXE` and `EDAT`. These rows are disregarded in the analysis. 

# Exploratory Data Analysis 

```{r}
covid.data.women <- covid.data %>% filter(SEXE == "Dona")
covid.data.men <- covid.data %>% filter(SEXE == "Home")
```

The data set is split into men and women. There are `r sum(covid.data.men$RECOMPTE)` critical cases for men and `r sum(covid.data.women$RECOMPTE)` critical cases for women in the data. 

### Cases of Critical Infection by Age and by Gender

```{r}
count.in.age.group <- function(data){
  data %>% group_by(SEXE, EDAT) %>% summarise(Count = sum(RECOMPTE), .groups = "keep")
}

all <- count.in.age.group(covid.data)
ggplot(all, aes(x = EDAT, y = Count)) + 
  labs(x = "Age Group", y = "Count") +
  geom_col(aes(fill = SEXE), position = "dodge") +
  geom_text(aes(label=Count, group= SEXE), vjust = 1.6, color="black", 
            size=3.5, position = position_dodge(width = 1)) +
  ggtitle("Cases of Critical COVID-19 Infection Grouped by Age") +
  theme_minimal()
```


### Evolution of Critical Infections in Time by Gender 

```{r}
count.each.week <- function(data){
  data %>% group_by(SEXE, Week) %>% summarise(Count = sum(RECOMPTE), .groups = "keep")
}

week.data <- count.each.week(covid.data)
ggplot(data = week.data, aes(x = as.factor(Week), y = Count)) +
  labs(x = "Week", y = "Count") +
  geom_col(aes(fill = SEXE), position = "dodge") +
  geom_text(aes(label=Count, group= SEXE), vjust = 1.6, color="black", 
            size=2, position = position_dodge(width = 1)) +
  ggtitle("Evolution of Critical Infections by Week") +
  theme_minimal()

count.each.month <- function(data){
  data %>% group_by(SEXE, Month) %>% summarise(Count = sum(RECOMPTE), .groups = "keep")
}

month.data <- count.each.month(covid.data)
ggplot(data = month.data, aes(x = as.factor(Month), y = Count)) +
  labs(x = "Month", y = "Count") +
  geom_col(aes(fill = SEXE), position = "dodge") +
  geom_text(aes(label=Count, group= SEXE), vjust = 1.6, color="black", 
            size=3, position = position_dodge(width = 0.9)) +
  ggtitle("Evolution of Critical Infections by Month") +
  theme_minimal()
```

### Cases of Critical Infection by Vaccination Status and Age for each Gender 

```{r, warning=FALSE}
group.by.vacc.age.gender <- function(data){
  data %>% group_by(SEXE, EDAT, PAUTA) %>% summarise(Count = sum(RECOMPTE), .groups = "keep")
}
d5 <- group.by.vacc.age.gender(covid.data)

ggplot(d5, aes(x = EDAT, y = Count)) + 
  labs(x = "Age Group", y = "Count") +
  geom_col(aes(fill = PAUTA), position = "dodge") +
  geom_text(aes(label=Count, group= PAUTA), vjust = 1.6, color="black", 
            size=2.5, position = position_dodge(width = 0.9)) +
  ggtitle("Critical Infections per Age Group based on Vaccination Status") +
  facet_wrap(~ SEXE) + 
  theme_minimal()

group.by.vacc.age <- function(data){
  data %>% group_by(EDAT, PAUTA) %>% summarise(Count = sum(RECOMPTE), .groups = "keep") 
}
d4 <- group.by.vacc.age(covid.data.women)
knitr::kable(d4, caption = "Women with Critical Infection as Function of Vaccination Status and Age")
d3 <- group.by.vacc.age(covid.data.men)
knitr::kable(d3, caption = "Men with Critical Infection as Function of Vaccination Status and Age")
```

### Vaccination Status per Age Group

When considering the critical cases by vaccination status and age for each gender, it is good to keep the vaccination status per age group in the population in mind. This data is shown below, where all four different classifications of severity of infection are kept in the data set. 

```{r}
count.vacc.status.in.age.group <- function(data){
  data %>% group_by(SEXE, EDAT, PAUTA) %>% summarise(Count = sum(RECOMPTE), .groups = "keep")
}

vacc.status.per.age <- count.vacc.status.in.age.group(clean(data))
ggplot(vacc.status.per.age, aes(x = EDAT, y = Count)) + 
  labs(x = "Age Group", y = "Count") +
  geom_col(aes(fill = PAUTA), position = "dodge") +
  geom_text(aes(label=Count, group= PAUTA), vjust = 1.6, color="black", 
            size=2.5, position = position_dodge(width = 0.9)) +
  ggtitle("Vaccination Status per Age Group") +
  facet_wrap(~ SEXE) + 
  theme_minimal()
```

# Model Fit  
### Linear Model

We wish to examine how the vaccination status affects the number of critical patients
in this period. Since we observe that the number of critical patients vary 
very much from month to month, we choose to group aggregate the number of 
patients each month, and include it as a categorical covariate in our model.

```{r}
covid.data.aggr <- aggregate(RECOMPTE ~ EDAT + SEXE + PAUTA + Month,
                             covid.data, FUN = sum)
covid.data.aggr$Month <- as.factor(covid.data.aggr$Month)
head(covid.data.aggr)
dim(covid.data.aggr)
```

First we try a simple linear model with all covariates included.
As the adjusted R-squared is low, and the residuals does not fit the normal 
assumption, we reject this model.

```{r}
model3 <- lm(RECOMPTE ~ EDAT + SEXE + PAUTA + Month, data = covid.data.aggr)
summary(model3)
par(mfrow = c(2,2))
plot(model3, ask = F)
```

Since we have aggregated the number of critical patients by month, we can interpret 
this data collection as a counting process which starts each months.
This is a poisson process, which we can fit as a general linear model
from the poisson family.
The model is fitted without interraction, and includes all covariates.
The residuals still look bad, and the model has a dispersion parameter above 
seven. 

```{r}
model5 <- glm(RECOMPTE ~ EDAT + SEXE + PAUTA + Month, data = covid.data.aggr, 
              family = poisson(link = "log"))
summary(model5)
par(mfrow = c(2,2))
plot(model5, ask = F)
# Checking for overdispersion
PS <- sum(residuals(model5, type="pearson")^2)
phi <- PS / model5$df.res
phi
```

Next we include an interaction between the vaccination status and month.
This has sense because the vaccination status should increase as a time goes,
and more people is vaccinated.

```{r}
model6 <- glm(RECOMPTE ~ EDAT + SEXE + PAUTA + Month + PAUTA:Month, data = covid.data.aggr, 
              family = poisson(link = "log"))
summary(model6)
par(mfrow = c(2,2))
plot(model6, ask = F)
# Checking for overdispersion
PS <- sum(residuals(model6, type="pearson")^2)
phi <- PS / model6$df.res
phi
```

The model improves, but the residuals still shows clear patterns, and the model
is overdispersed.
Now we include an interaction between vaccination status and age group.
This has sense since the older age group likely was vaccinated earlier than
the younger age group.

```{r}
model7 <- glm(RECOMPTE ~ EDAT + SEXE + PAUTA + Month + PAUTA:Month + EDAT:PAUTA, data = covid.data.aggr, 
              family = poisson(link = "log"))
summary(model7)
par(mfrow = c(2,2))
plot(model7, ask = F)
# Checking for overdispersion
PS <- sum(residuals(model7, type="pearson")^2)
PS
phi <- PS / model7$df.res
phi
anova(model7)
qchisq(0.95, model7$df.res, lower.tail=TRUE)
```

Now the model shows clear improvement, and the dispersion parameter is reduced
to right above two.


```{r}
model8 <- glm(RECOMPTE ~ SEXE + EDAT*PAUTA*Month,
              data = covid.data.aggr, 
              family = poisson(link = "log"))
summary(model8)
par(mfrow = c(2,2))
plot(model8, ask = F)
# Checking for overdispersion
PS <- sum(residuals(model8, type="pearson")^2)
PS
phi <- PS / model8$df.res
phi
anova(model8)
qchisq(0.95, model8$df.res, lower.tail=TRUE)
```


# Conclusions
